<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <script type="module">
    async function init() {
      const { instance } = await WebAssembly.instantiateStreaming(
        fetch("./bare_metal_fractal.wasm"),
        {
          "env": {
            "js_logu": console.log,
            "js_logf": console.log,
          },
        }
      );

      const width = 600;
      const height = 600;

      const canvas = document.getElementById("demo-canvas");
      canvas.width = width;
      canvas.height = height;

      const { alloc_tile, free_tile, get_buffer, render } = instance.exports;

      // https://stackoverflow.com/questions/51659292/javascript-arraybuffer-detaches-when-constructing-a-new-rust-vec-via-wasm
      // this pointer is invalidated when the wasm memory buffer is grown?

      function getImageData(t) {
        return new ImageData(
          new Uint8ClampedArray(
            instance.exports.memory.buffer,
            get_buffer(t),
            4 * width * height
          ),
          width
        );
      }

      const ctx = canvas.getContext("2d");

      function renderToCanvas() {
        const tile = alloc_tile(width, height);
        render(tile, 1000, -0.5, 0.0, 3.0);
        ctx.putImageData(getImageData(tile), 0, 0);
        free_tile(tile);
      }

      renderToCanvas();
    }

    init();
  </script>
</head>

<body>
  <canvas id="demo-canvas"></canvas>
</body>

</html>