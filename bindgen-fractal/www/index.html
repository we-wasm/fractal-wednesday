<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <style>
    body {
      margin: 0;
    }

    #demo-canvas {
      position: absolute;
    }
  </style>
  <script type="module">
    /** @type {import('../pkg/bindgen_fractal.d.ts')} */
    import init, { new_fractal, mouse_down, mouse_up, mouse_move, zoom, render } from './bindgen_fractal.js';
    async function init_this() {
      const wasm_exports = await init();

      const canvas = document.getElementById("demo-canvas");
      let lastW = canvas.width = window.innerWidth;
      let lastH = canvas.height = window.innerHeight;

      const uiState = new_fractal();

      function renderFractal() {
        const { width, height } = canvas;
        const start = performance.now();
        const ctx = canvas.getContext('2d');
        render(uiState, ctx, width, height);
        const elapsed = performance.now() - start;
        console.log(`Rendered ${width * height} samples in ${elapsed}ms using ${wasm_exports.memory.buffer.byteLength / 1000000}M`);
        return uiState;
      }


      function getUV(e) {
        return [e.offsetX / e.target.width, e.offsetY / e.target.height];
      }
      canvas.addEventListener("mousedown", (e) => {
        mouse_down(uiState, ...getUV(e));
        renderFractal();
      });
      canvas.addEventListener("mouseup", () => {
        mouse_up(uiState);
        renderFractal();
      });
      canvas.addEventListener("mousemove", (e) => {
        mouse_move(uiState, ...getUV(e));
        // Issue: this doesn't check for mouse down or up?
        renderFractal();
      });
      canvas.addEventListener("wheel", (e) => {
        // deltaY tends to be in the range of 3 to -3
        zoom(uiState, e.deltaY / 100, ...getUV(e));
        renderFractal();
      });

      function getSize() {
        return {
          width: window.innerWidth,
          height: window.innerHeight
        }
      }

      setInterval(() => {
        const { width, height } = getSize();
        if (lastW !== width || lastH !== height) {
          canvas.width = lastW = width;
          canvas.height = lastH = height;
          renderFractal();
        }
      }, 100);

      renderFractal();
    }

    init_this();
  </script>
</head>

<body>
  <canvas id="demo-canvas"></canvas>
</body>

</html>